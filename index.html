<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TÍNH ĐIỂM GPA</title>
  <!-- Warning: Using Tailwind CSS CDN for development/prototyping only. For production, install as a PostCSS plugin or use Tailwind CLI: https://tailwindcss.com/docs/installation -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">TÍNH ĐIỂM GPA</h1>
    <div class="mb-4">
      <label for="dataInput" class="block text-lg font-medium mb-2">Dán vào:</label>
      <textarea id="dataInput" rows="10" class="w-full p-2 border rounded-md" placeholder="Paste your data from the school website..."></textarea>
      <button onclick="processData()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">TÍNH ĐIỂM GPA</button>
    </div>

    <div class="mb-4 text-lg font-medium">
      <span>GPA Kỳ (10): </span><span id="semesterGPA10" class="font-bold">0.00</span>
      <span class="ml-4">GPA Kỳ (4): </span><span id="semesterGPA4" class="font-bold">0.00</span>
    </div>

    <div id="result" class="mt-6">
      <table id="gpaTable" class="w-full border-collapse border bg-white">
        <thead>
          <tr class="bg-gray-200">
            <th class="border p-2">Kỳ/Năm học</th>
            <th class="border p-2">Tên môn học</th>
            <th class="border p-2">Số TC</th>
            <th class="border p-2">Hệ số điểm</th>
            <th class="border p-2">ĐIỂM BT</th>
            <th class="border p-2">ĐIỂM CK</th>
            <th class="border p-2">ĐIỂM DA</th>
            <th class="border p-2">ĐIỂM GK</th>
            <th class="border p-2">ĐIỂM GPA 10</th>
            <th class="border p-2">ĐIỂM GPA 4</th>
            <th class="border p-2">Chữ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="gpaSummary"></tfoot>
      </table>
    </div>
    <div class="mt-6 text-center text-sm font-medium">
      Contact: <a href="mailto:thanhvinhphanle@gmail.com" class="text-blue-500 hover:underline">thanhvinhphanle@gmail.com</a>
    </div>
  </div>

  <script>
    // Biến toàn cục để lưu trữ GPA theo kỳ
    let semesterGPA = {};

    function calculateGPA10(subject) {
      const { formula, bt, ck, da, gk } = subject;
      // Nếu không có điểm CK hoặc CK không hợp lệ, trả về 0.0
      if (ck === null || isNaN(ck)) return '0.0';

      // Nếu không có công thức, trả về điểm CK trực tiếp
      if (!formula) return ck.toFixed(1);

      let gpa10 = 0;
      const parts = formula.split('+').map(part => part.trim());
      let hasValidScore = false;

      parts.forEach(part => {
        const [_, component, weight] = part.match(/\[(\w+)\]\*([\d\.]+)/) || [];
        const w = parseFloat(weight);
        if (component === 'CK') {
          gpa10 += ck * w; // CK luôn được tính vì đã kiểm tra ở trên
          hasValidScore = true;
        }
        if (component === 'GK' && gk !== null && !isNaN(gk)) {
          gpa10 += gk * w;
          hasValidScore = true;
        }
        if (component === 'BT' && bt !== null && !isNaN(bt)) {
          gpa10 += bt * w;
          hasValidScore = true;
        }
        if (component === 'DA' && da !== null && !isNaN(da)) {
          gpa10 += da * w;
          hasValidScore = true;
        }
      });

      return hasValidScore ? gpa10.toFixed(1) : ck.toFixed(1); // Nếu không có công thức hợp lệ, trả về điểm CK
    }

    function calculateGPA4(gpa10) {
      gpa10 = parseFloat(gpa10) || 0;
      if (gpa10 >= 9.5) return 4.0;
      if (gpa10 >= 8.5) return 4.0;
      if (gpa10 >= 8.0) return 3.5;
      if (gpa10 >= 7.0) return 3.0;
      if (gpa10 >= 6.5) return 2.5;
      if (gpa10 >= 5.5) return 2.0;
      if (gpa10 >= 5.0) return 1.5;
      if (gpa10 >= 4.0) return 1.0;
      return 0;
    }

    function getLetterGrade(gpa10) {
      gpa10 = parseFloat(gpa10) || 0;
      if (gpa10 >= 9.5) return 'A+';
      if (gpa10 >= 8.5) return 'A';
      if (gpa10 >= 8.0) return 'B+';
      if (gpa10 >= 7.0) return 'B';
      if (gpa10 >= 6.5) return 'C+';
      if (gpa10 >= 5.5) return 'C';
      if (gpa10 >= 5.0) return 'D+';
      if (gpa10 >= 4.0) return 'D';
      return 'F';
    }

    function processData() {
      const dataInput = document.getElementById('dataInput').value;
      const rows = dataInput.split('\n').filter(row => row.trim() !== '');
      const tableBody = document.getElementById('tableBody');
      const gpaSummary = document.getElementById('gpaSummary');
      tableBody.innerHTML = '';
      gpaSummary.innerHTML = '';
      semesterGPA = {}; // Reset semesterGPA

      const subjects = [];
      rows.forEach(row => {
        const cols = row.split('\t').map(col => col.trim());
        if (cols.length < 10) return; // Đảm bảo đủ cột
        const subject = {
          semester: cols[1] || '', // Kỳ/Năm học
          name: cols[4] || '',
          credits: parseFloat(cols[5]) || 0,
          formula: cols[6] || '',
          bt: parseFloat(cols[7]) || null,
          ck: parseFloat(cols[8]) || null,
          da: parseFloat(cols[9]) || null,
          gk: parseFloat(cols[10]) || null,
          gpa10: parseFloat(cols[11]) || null,
          gpa4: parseFloat(cols[12]) || null,
          letter: cols[13] || ''
        };
        subjects.push(subject);
      });

      subjects.forEach(subject => {
        // Hiển thị tất cả các môn, kể cả khi thiếu điểm CK
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border p-2">${subject.semester}</td>
          <td class="border p-2">${subject.name}</td>
          <td class="border p-2">${subject.credits || ''}</td>
          <td class="border p-2">${subject.formula}</td>
          <td class="border p-2"><input type="number" step="0.1" min="0" max="10" value="${subject.bt !== null ? subject.bt : ''}" onchange="updateGPA(this)" class="w-16 p-1 border rounded"></td>
          <td class="border p-2"><input type="number" step="0.1" min="0" max="10" value="${subject.ck !== null ? subject.ck : ''}" onchange="updateGPA(this)" class="w-16 p-1 border rounded"></td>
          <td class="border p-2"><input type="number" step="0.1" min="0" max="10" value="${subject.da !== null ? subject.da : ''}" onchange="updateGPA(this)" class="w-16 p-1 border rounded"></td>
          <td class="border p-2"><input type="number" step="0.1" min="0" max="10" value="${subject.gk !== null ? subject.gk : ''}" onchange="updateGPA(this)" class="w-16 p-1 border rounded"></td>
          <td class="border p-2 gpa10">${calculateGPA10(subject)}</td>
          <td class="border p-2 gpa4">${calculateGPA4(calculateGPA10(subject))}</td>
          <td class="border p-2 letter">${getLetterGrade(calculateGPA10(subject))}</td>
        `;
        tableBody.appendChild(row);

        // Chỉ tính GPA cho các môn có điểm CK hợp lệ
        if (subject.ck !== null && !isNaN(subject.ck)) {
          const sem = subject.semester;
          if (!semesterGPA[sem]) {
            semesterGPA[sem] = { totalPoints10: 0, totalPoints4: 0, totalCredits: 0 };
          }
          const gpa10 = parseFloat(calculateGPA10(subject)) || 0;
          const gpa4 = parseFloat(calculateGPA4(gpa10)) || 0;
          if (subject.credits > 0 && gpa10 > 0) {
            semesterGPA[sem].totalPoints10 += gpa10 * subject.credits;
            semesterGPA[sem].totalPoints4 += gpa4 * subject.credits;
            semesterGPA[sem].totalCredits += subject.credits;
          }
        }
      });

      // Hiển thị GPA từng kỳ
      for (const [sem, data] of Object.entries(semesterGPA)) {
        const gpa10 = data.totalCredits ? (data.totalPoints10 / data.totalCredits).toFixed(2) : '0.00';
        const gpa4 = data.totalCredits ? (data.totalPoints4 / data.totalCredits).toFixed(2) : '0.00';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border p-2" colspan="2">${sem}</td>
          <td class="border p-2" colspan="6"></td>
          <td class="border p-2 font-bold">${gpa10}</td>
          <td class="border p-2 font-bold">${gpa4}</td>
          <td class="border p-2"></td>
        `;
        gpaSummary.appendChild(row);
      }

      updateSemesterGPA();
    }

    function updateGPA(input) {
      const row = input.parentElement.parentElement;
      const subject = {
        formula: row.cells[3].textContent,
        bt: parseFloat(row.cells[4].querySelector('input').value) || null,
        ck: parseFloat(row.cells[5].querySelector('input').value) || null,
        da: parseFloat(row.cells[6].querySelector('input').value) || null,
        gk: parseFloat(row.cells[7].querySelector('input').value) || null,
        credits: parseFloat(row.cells[2].textContent) || 0,
        semester: row.cells[0].textContent
      };

      // Cập nhật GPA cho hàng hiện tại
      const gpa10 = calculateGPA10(subject);
      row.querySelector('.gpa10').textContent = gpa10;
      const gpa4 = calculateGPA4(gpa10);
      row.querySelector('.gpa4').textContent = gpa4;
      row.querySelector('.letter').textContent = getLetterGrade(gpa10);

      // Cập nhật semesterGPA
      semesterGPA = { }; // Reset để tính lại
      const rows = Array.from(document.querySelectorAll('#gpaTable tbody tr'));
      rows.forEach(row => {
        const credits = parseFloat(row.cells[2].textContent) || 0;
        const gpa10 = parseFloat(row.querySelector('.gpa10').textContent) || 0;
        const gpa4 = parseFloat(row.querySelector('.gpa4').textContent) || 0;
        const ck = parseFloat(row.cells[5].querySelector('input').value) || null;
        const semester = row.cells[0].textContent;

        if (credits > 0 && ck !== null && !isNaN(ck) && gpa10 > 0) {
          if (!semesterGPA[semester]) {
            semesterGPA[semester] = { totalPoints10: 0, totalPoints4: 0, totalCredits: 0 };
          }
          semesterGPA[semester].totalPoints10 += gpa10 * credits;
          semesterGPA[semester].totalPoints4 += gpa4 * credits;
          semesterGPA[semester].totalCredits += credits;
        }
      });

      updateSemesterGPA();
    }

    function updateSemesterGPA() {
      // Tính GPA tổng cho tất cả các kỳ
      let totalPoints10 = 0;
      let totalPoints4 = 0;
      let totalCredits = 0;

      for (const [sem, data] of Object.entries(semesterGPA)) {
        totalPoints10 += data.totalPoints10;
        totalPoints4 += data.totalPoints4;
        totalCredits += data.totalCredits;
      }

      const semesterGPA10 = totalCredits ? (totalPoints10 / totalCredits).toFixed(2) : '0.00';
      const semesterGPA4 = totalCredits ? (totalPoints4 / totalCredits).toFixed(2) : '0.00';

      document.getElementById('semesterGPA10').textContent = semesterGPA10;
      document.getElementById('semesterGPA4').textContent = semesterGPA4;

      // Hiển thị GPA của kỳ cụ thể (ví dụ: Kỳ 2/2024-2025)
      const selectedSemester = "2/2024-2025"; // Cập nhật để khớp với dữ liệu đầu vào
      if (semesterGPA[selectedSemester]) {
        const gpa10 = semesterGPA[selectedSemester].totalCredits
          ? (semesterGPA[selectedSemester].totalPoints10 / semesterGPA[selectedSemester].totalCredits).toFixed(2)
          : '0.00';
        const gpa4 = semesterGPA[selectedSemester].totalCredits
          ? (semesterGPA[selectedSemester].totalPoints4 / semesterGPA[selectedSemester].totalCredits).toFixed(2)
          : '0.00';
        document.getElementById('semesterGPA10').textContent = gpa10;
        document.getElementById('semesterGPA4').textContent = gpa4;
      }
    }
  </script>
</body>
</html>
